<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>FocusGroup - Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#22C55E",
                        "primary-dark": "#16a34a",
                        "background-dark": "#121212",
                        "surface-light": "#1E1E1E",
                        "card-border": "#2d2d2d",
                        "input-dark": "#2A2A2A",
                    },
                    fontFamily: { "display":["Lexend", "sans-serif"] }
                }
            }
        }
    </script>
    <style> 
        body { font-family: 'Lexend', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .font-variation-settings-fill { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    </style>
</head>
<body class="bg-black text-white antialiased selection:bg-primary selection:text-white flex justify-center min-h-screen">

<!-- Mobile App Container -->
<div class="w-full max-w-md bg-background-dark h-[100dvh] flex flex-col relative shadow-2xl overflow-hidden border-x border-card-border/30">
    
    <!-- Header Section -->
    <header class="flex-shrink-0 z-50 bg-background-dark/95 backdrop-blur-md px-5 py-4 flex items-center justify-between border-b border-card-border">
        <a href="/dashboard" class="flex size-10 items-center justify-center rounded-full hover:bg-input-dark text-white transition-colors">
            <span class="material-symbols-outlined">arrow_back</span>
        </a>
        <h2 class="text-[18px] font-bold text-white tracking-tight">Profile</h2>
        <a href="#" class="flex size-10 items-center justify-center rounded-full hover:bg-input-dark text-white transition-colors">
            <span class="material-symbols-outlined">settings</span>
        </a>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto no-scrollbar pb-28">
        
        <!-- Global Loader inside Main (Professional Skeleton) -->
        <div id="profile-loader" class="flex flex-col w-full animate-pulse pb-10">
            <!-- Profile Avatar & Info Skeleton -->
            <div class="flex flex-col items-center px-5 pt-8 pb-6">
                <div class="h-28 w-28 rounded-full bg-input-dark mb-5 border-2 border-surface-light"></div>
                <div class="h-6 w-48 bg-surface-light rounded mb-2 mt-1"></div>
                <div class="h-4 w-32 bg-surface-light rounded"></div>
            </div>

            <!-- Stats Grid Skeleton -->
            <div class="grid grid-cols-3 gap-3 px-5 mb-8">
                <div class="flex flex-col items-center gap-2 rounded-3xl bg-surface-light p-4 border border-card-border">
                    <div class="w-10 h-10 rounded-full bg-input-dark mb-1"></div>
                    <div class="w-10 h-6 bg-input-dark rounded"></div>
                    <div class="w-16 h-3 bg-input-dark rounded"></div>
                </div>
                <div class="flex flex-col items-center gap-2 rounded-3xl bg-surface-light p-4 border border-card-border">
                    <div class="w-10 h-10 rounded-full bg-input-dark mb-1"></div>
                    <div class="w-10 h-6 bg-input-dark rounded"></div>
                    <div class="w-16 h-3 bg-input-dark rounded"></div>
                </div>
                <div class="flex flex-col items-center gap-2 rounded-3xl bg-surface-light p-4 border border-card-border">
                    <div class="w-10 h-10 rounded-full bg-input-dark mb-1"></div>
                    <div class="w-10 h-6 bg-input-dark rounded"></div>
                    <div class="w-16 h-3 bg-input-dark rounded"></div>
                </div>
            </div>

            <!-- My Subjects Skeleton -->
            <div class="px-5 mb-8">
                <div class="w-24 h-5 bg-surface-light rounded mb-3"></div>
                <div class="flex flex-wrap gap-2.5">
                    <div class="w-20 h-7 bg-surface-light rounded-xl"></div>
                    <div class="w-16 h-7 bg-surface-light rounded-xl"></div>
                    <div class="w-24 h-7 bg-surface-light rounded-xl"></div>
                    <div class="w-7 h-7 bg-surface-light rounded-full border border-dashed border-gray-500"></div>
                </div>
            </div>

            <!-- Info List Skeleton -->
            <div class="mx-5 mb-8 overflow-hidden rounded-3xl bg-surface-light border border-card-border">
                <div class="flex items-center gap-3 border-b border-card-border p-4">
                    <div class="h-10 w-10 rounded-xl bg-input-dark flex-shrink-0"></div>
                    <div class="flex flex-col gap-1.5 flex-1">
                        <div class="w-24 h-3 bg-input-dark rounded"></div>
                        <div class="w-32 h-4 bg-input-dark rounded"></div>
                    </div>
                </div>
                <div class="flex items-center gap-3 border-b border-card-border p-4">
                    <div class="h-10 w-10 rounded-xl bg-input-dark flex-shrink-0"></div>
                    <div class="flex flex-col gap-1.5 flex-1">
                        <div class="w-20 h-3 bg-input-dark rounded"></div>
                        <div class="w-40 h-4 bg-input-dark rounded"></div>
                    </div>
                </div>
                <div class="flex items-center gap-3 p-4">
                    <div class="h-10 w-10 rounded-xl bg-input-dark flex-shrink-0"></div>
                    <div class="flex flex-col gap-1.5 flex-1">
                        <div class="w-16 h-3 bg-input-dark rounded"></div>
                        <div class="w-28 h-4 bg-input-dark rounded"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Content (Hidden until loaded) -->
        <div id="profile-content" class="hidden flex flex-col">
            <!-- Profile Avatar & Info -->
            <div class="flex flex-col items-center px-5 pt-8 pb-6">
                <div class="relative mb-5 group cursor-pointer" id="avatar-container">
                    <input type="file" id="profile-image-input" class="hidden" accept="image/*" />
                    <!-- Glowing Ring -->
                    <div class="absolute -inset-1.5 rounded-full bg-gradient-to-tr from-primary to-green-300 opacity-60 blur-md group-hover:opacity-100 transition-opacity"></div>
                    
                    <div class="relative h-28 w-28 rounded-full p-1 bg-background-dark">
                        <div id="profile-avatar" class="h-full w-full rounded-full bg-cover bg-center border-2 border-primary bg-input-dark" style="background-image: url('https://ui-avatars.com/api/?name=Loading&background=22C55E&color=fff');"></div>
                        
                        <!-- Upload Loader -->
                        <div id="avatar-loader" class="absolute inset-0 bg-black/70 rounded-full flex flex-col items-center justify-center hidden">
                            <div class="w-6 h-6 border-2 border-white border-t-primary rounded-full animate-spin mb-1"></div>
                        </div>
                    </div>
                    <button class="absolute bottom-0 right-0 flex h-8 w-8 items-center justify-center rounded-full bg-primary text-white shadow-md border-2 border-background-dark group-hover:bg-primary-dark transition-colors">
                        <span class="material-symbols-outlined text-[16px]">photo_camera</span>
                    </button>
                </div>
                
                <h1 id="user-name" class="text-[22px] font-bold text-white">Loading...</h1>
                <p id="user-subtitle" class="text-gray-400 font-medium text-sm mt-1">Fetching details...</p>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-3 gap-3 px-5 mb-8">
                <div class="flex flex-col items-center gap-1 rounded-3xl bg-surface-light p-4 shadow-sm border border-card-border">
                    <div class="rounded-full bg-primary/10 p-2 mb-1">
                        <span class="material-symbols-outlined text-primary text-[20px]">schedule</span>
                    </div>
                    <p id="stat-hours" class="text-[20px] font-bold text-white">0h</p>
                    <p class="text-[11px] font-medium text-gray-400">Total Hours</p>
                </div>
                <div class="flex flex-col items-center gap-1 rounded-3xl bg-surface-light p-4 shadow-sm border border-card-border">
                    <div class="rounded-full bg-primary/10 p-2 mb-1">
                        <span class="material-symbols-outlined text-primary text-[20px]">groups</span>
                    </div>
                    <p id="stat-groups" class="text-[20px] font-bold text-white">0</p>
                    <p class="text-[11px] font-medium text-gray-400">Groups</p>
                </div>
                <div class="flex flex-col items-center gap-1 rounded-3xl bg-surface-light p-4 shadow-sm border border-card-border">
                    <div class="rounded-full bg-primary/10 p-2 mb-1">
                        <span class="material-symbols-outlined text-primary text-[20px]">leaderboard</span>
                    </div>
                    <p id="stat-rank" class="text-[20px] font-bold text-white">#0</p>
                    <p class="text-[11px] font-medium text-gray-400">Rank</p>
                </div>
            </div>

            <!-- My Subjects -->
            <div class="px-5 mb-8">
                <h3 class="text-[16px] font-bold text-white mb-3 tracking-wide">My Subjects</h3>
                <div id="subjects-container" class="flex flex-wrap gap-2.5">
                    <!-- Dynamic Subjects will be injected here -->
                </div>
            </div>

            <!-- Info List -->
            <div class="mx-5 mb-8 overflow-hidden rounded-3xl bg-surface-light shadow-sm border border-card-border">
                <div class="flex items-center justify-between border-b border-card-border p-4">
                    <div class="flex items-center gap-3">
                        <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-input-dark border border-card-border text-gray-300">
                            <span class="material-symbols-outlined">school</span>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-0.5">Education Level</p>
                            <p id="info-education" class="text-sm font-medium text-white">Not provided</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center justify-between border-b border-card-border p-4">
                    <div class="flex items-center gap-3">
                        <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-input-dark border border-card-border text-gray-300">
                            <span class="material-symbols-outlined">apartment</span>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-0.5">Institution</p>
                            <p id="info-institution" class="text-sm font-medium text-white">Not provided</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center justify-between p-4">
                    <div class="flex items-center gap-3">
                        <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-input-dark border border-card-border text-gray-300">
                            <span class="material-symbols-outlined">flag</span>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-0.5">Goal</p>
                            <p id="info-goal" class="text-sm font-medium text-white">Not provided</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions List -->
            <div class="mx-5 mb-6 overflow-hidden rounded-3xl bg-surface-light shadow-sm border border-card-border">
                <!-- UPDATED LINK HERE FOR EDIT PROFILE -->
                <a href="/edit-profile" class="flex items-center justify-between border-b border-card-border p-4 hover:bg-input-dark transition-colors">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-gray-400">person</span>
                        <span class="text-[15px] font-bold text-white">Edit Profile</span>
                    </div>
                    <span class="material-symbols-outlined text-gray-500">chevron_right</span>
                </a>
                <a href="/notifications" class="flex items-center justify-between border-b border-card-border p-4 hover:bg-input-dark transition-colors">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-gray-400">notifications</span>
                        <span class="text-[15px] font-bold text-white">Notifications</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white">2</span>
                        <span class="material-symbols-outlined text-gray-500">chevron_right</span>
                    </div>
                </a>
                <a href="#" class="flex items-center justify-between border-b border-card-border p-4 hover:bg-input-dark transition-colors">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-gray-400">lock</span>
                        <span class="text-[15px] font-bold text-white">Privacy & Security</span>
                    </div>
                    <span class="material-symbols-outlined text-gray-500">chevron_right</span>
                </a>
                <button id="logout-btn" class="flex w-full items-center justify-between p-4 hover:bg-red-500/10 transition-colors">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-red-500">logout</span>
                        <span class="text-[15px] font-bold text-red-500">Log Out</span>
                    </div>
                </button>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="absolute bottom-0 left-0 right-0 bg-surface-light border-t border-card-border pb-6 pt-3 px-6 flex justify-between items-end z-50">
        <a class="flex flex-col items-center justify-end gap-1.5 text-gray-400 group hover:text-gray-200 transition-colors" href="/dashboard">
            <div class="h-8 flex items-center justify-center transition-transform group-active:scale-90">
                <span class="material-symbols-outlined text-[28px]">home</span>
            </div>
            <p class="text-[10px] font-medium leading-none">Home</p>
        </a>
        <a class="flex flex-col items-center justify-end gap-1.5 text-gray-400 group hover:text-gray-200 transition-colors" href="#">
            <div class="h-8 flex items-center justify-center transition-transform group-active:scale-90">
                <span class="material-symbols-outlined text-[28px]">calendar_month</span>
            </div>
            <p class="text-[10px] font-medium leading-none">Calendar</p>
        </a>
        <a class="flex flex-col items-center justify-end gap-1.5 text-gray-400 group hover:text-gray-200 transition-colors" href="/groups">
            <div class="h-8 flex items-center justify-center transition-transform group-active:scale-90">
                <span class="material-symbols-outlined text-[28px]">groups</span>
            </div>
            <p class="text-[10px] font-medium leading-none">Groups</p>
        </a>
        <a class="flex flex-col items-center justify-end gap-1.5 text-gray-400 group hover:text-gray-200 transition-colors" href="#">
            <div class="h-8 flex items-center justify-center transition-transform group-active:scale-90">
                <span class="material-symbols-outlined text-[28px]">smart_toy</span>
            </div>
            <p class="text-[10px] font-medium leading-none">AI</p>
        </a>
        <a class="flex flex-col items-center justify-end gap-1.5 text-primary group" href="/profile">
            <div class="h-8 flex items-center justify-center transition-transform group-active:scale-90">
                <span class="material-symbols-outlined text-[28px] font-variation-settings-fill">person</span>
            </div>
            <p class="text-[10px] font-medium leading-none">Profile</p>
        </a>
    </nav>
</div>

<!-- Firebase & Logic Script -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDofDHfJvIKQmTtlg7x99mBtimuMmUUhBY",
        authDomain: "facebook-379b3.firebaseapp.com",
        projectId: "facebook-379b3",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const imgbbApiKey = "957a2f2e8fc22269da1f2045b3f25eab";
    let currentUserUid = null;

    // UI Elements
    const profileLoader = document.getElementById("profile-loader");
    const profileContent = document.getElementById("profile-content");
    
    const userNameEl = document.getElementById("user-name");
    const userSubtitleEl = document.getElementById("user-subtitle");
    const profileAvatarEl = document.getElementById("profile-avatar");
    const avatarLoader = document.getElementById("avatar-loader");
    const imageInput = document.getElementById("profile-image-input");
    const avatarContainer = document.getElementById("avatar-container");
    
    const infoEducation = document.getElementById("info-education");
    const infoInstitution = document.getElementById("info-institution");
    const infoGoal = document.getElementById("info-goal");
    const subjectsContainer = document.getElementById("subjects-container");
    
    const statHours = document.getElementById("stat-hours");
    const statGroups = document.getElementById("stat-groups");
    const statRank = document.getElementById("stat-rank");

    // Subject Colors Map
    const badgeColors =[
        "bg-blue-500/10 text-blue-400 border-blue-500/20",
        "bg-amber-500/10 text-amber-400 border-amber-500/20",
        "bg-rose-500/10 text-rose-400 border-rose-500/20",
        "bg-emerald-500/10 text-emerald-400 border-emerald-500/20",
        "bg-purple-500/10 text-purple-400 border-purple-500/20"
    ];

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUserUid = user.uid;
            await loadUserProfile(user);
            loadUserStats(user.uid);
            loadGroupsCount(user.uid);
        } else {
            window.location.href = "/auth"; 
        }
    });

    async function loadUserProfile(user) {
        try {
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            
            let fullName = "FocusGroup Student";
            let photoURL = "";
            let educationLevel = "Not set";
            let institution = "Not set";
            let goal = "Not set";
            let subjects =[];

            if (userDoc.exists()) {
                const data = userDoc.data();
                fullName = data.fullName || fullName;
                photoURL = data.photoURL || `https://ui-avatars.com/api/?name=${fullName}&background=22C55E&color=fff`;
                educationLevel = data.educationLevel || educationLevel;
                institution = data.institution || institution;
                goal = data.goal || goal;
                subjects = data.subjects ||[];
            } else {
                photoURL = `https://ui-avatars.com/api/?name=${fullName}&background=22C55E&color=fff`;
            }

            // Update Basic Text
            userNameEl.innerText = fullName;
            userSubtitleEl.innerText = educationLevel;
            profileAvatarEl.style.backgroundImage = `url('${photoURL}')`;
            
            infoEducation.innerText = educationLevel;
            infoInstitution.innerText = institution;
            infoGoal.innerText = goal;

            // Render Subjects
            subjectsContainer.innerHTML = '';
            if(subjects.length > 0) {
                subjects.forEach((sub, index) => {
                    const colorClass = badgeColors[index % badgeColors.length];
                    const badge = `<span class="inline-flex items-center rounded-xl px-3 py-1 text-[13px] font-bold border ${colorClass}">${sub}</span>`;
                    subjectsContainer.insertAdjacentHTML('beforeend', badge);
                });
            } else {
                subjectsContainer.innerHTML = `<span class="text-sm text-gray-500 font-medium">No subjects added yet.</span>`;
            }

            // Add "Plus" button for subjects
            subjectsContainer.insertAdjacentHTML('beforeend', `
                <button class="inline-flex h-7 w-7 items-center justify-center rounded-full border border-dashed border-gray-500 bg-transparent text-gray-400 hover:text-primary hover:border-primary transition-colors">
                    <span class="material-symbols-outlined text-[18px]">add</span>
                </button>
            `);

            profileLoader.classList.add("hidden");
            profileContent.classList.remove("hidden");
        } catch (error) {
            console.error("Error loading profile:", error);
        }
    }

    function loadUserStats(uid) {
        const statsRef = doc(db, "users", uid, "stats", "summary");
        onSnapshot(statsRef, (docSnap) => {
            if (docSnap.exists()) {
                const stats = docSnap.data();
                // Assuming todayFocusedMinutes or totalFocusedMinutes exists. Fallback to 0.
                let totalMinutes = stats.totalFocusedMinutes || stats.todayFocusedMinutes || 0;
                let hours = Math.floor(totalMinutes / 60);
                statHours.innerText = `${hours}h`;
                // Dummy logic for Rank - you can change this to real logic later
                statRank.innerText = `#${stats.streakDays > 0 ? 100 - stats.streakDays : 100}`;
            }
        });
    }

    async function loadGroupsCount(uid) {
        try {
            // Find all groups where the user is a member
            const q = query(collection(db, "groups"), where("members", "array-contains", uid));
            const snapshot = await getDocs(q);
            statGroups.innerText = snapshot.size;
        } catch (error) {
            console.error("Error fetching group count:", error);
        }
    }

    // --- Avatar Upload Logic (ImgBB + Firestore) ---
    avatarContainer.addEventListener("click", () => imageInput.click());

    imageInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file || !currentUserUid) return;

        avatarLoader.classList.remove("hidden");

        // Local Preview immediately
        const reader = new FileReader();
        reader.onload = (event) => {
            profileAvatarEl.style.backgroundImage = `url(${event.target.result})`;
        };
        reader.readAsDataURL(file);

        const formData = new FormData();
        formData.append('image', file);

        try {
            // Upload to ImgBB
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            
            if (data.success) {
                const uploadedUrl = data.data.url;
                // Update in Firestore
                await updateDoc(doc(db, "users", currentUserUid), {
                    photoURL: uploadedUrl
                });
                profileAvatarEl.style.backgroundImage = `url('${uploadedUrl}')`;
            } else {
                alert("Failed to upload image.");
            }
        } catch (error) {
            console.error("Error uploading:", error);
            alert("Upload failed. Try again.");
        } finally {
            avatarLoader.classList.add("hidden");
        }
    });

    // --- Log Out ---
    document.getElementById("logout-btn").addEventListener("click", () => {
        if(confirm("Are you sure you want to log out?")) {
            signOut(auth).then(() => {
                window.location.href = "/auth";
            });
        }
    });

</script>
</body>
</html>