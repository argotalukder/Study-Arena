<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport"/>
    <title>FocusGroup - Live Room</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#21c45d",
                        "accent": "#f97316", /* Orange for the UI theme in screenshot */
                        "background-dark": "#121212",
                        "card-dark": "#1E1E1E",
                        "input-dark": "#2A2A2A",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"],
                        "poppins": ["Poppins", "sans-serif"]
                    },
                    spacing: {
                        'safe-bottom': 'env(safe-area-inset-bottom)',
                    }
                },
            },
        }
    </script>
    <style> 
        body { font-family: 'Lexend', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-background-dark text-slate-100 h-[100dvh] flex justify-center overflow-hidden font-poppins">

    <div class="w-full max-w-md bg-background-dark h-full flex flex-col relative shadow-2xl overflow-hidden text-white">
        
        <!-- Header -->
        <div class="flex items-center justify-between px-4 pt-12 pb-4 bg-background-dark z-20 border-b border-white/5 flex-shrink-0">
            <button onclick="history.back()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/5 text-slate-300 transition-colors">
                <span class="material-symbols-outlined">arrow_back_ios_new</span>
            </button>
            <div class="text-center">
                <h1 id="room-title" class="text-lg font-bold tracking-tight text-white font-display flex items-center justify-center gap-2">
                    Loading...
                </h1>
            </div>
            <button class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/5 text-slate-300 transition-colors">
                <span class="material-symbols-outlined">search</span>
            </button>
        </div>

        <!-- Notification Banner -->
        <div class="px-4 py-3 bg-background-dark z-10 flex-shrink-0">
            <div class="bg-card-dark rounded-xl p-3 flex items-center gap-3 border border-white/5 shadow-sm">
                <span class="material-symbols-outlined text-red-400 text-sm">campaign</span>
                <p class="text-xs text-slate-300">Something special is waiting for you üéÅ</p>
            </div>
        </div>

        <!-- Stats & Filters -->
        <div class="px-6 py-2 flex items-center justify-between flex-shrink-0">
            <div class="text-sm font-medium text-slate-300">
                Studying <span id="member-count" class="text-primary">0 members</span>
            </div>
            <div class="flex gap-2">
                <button class="w-8 h-8 rounded-full bg-card-dark border border-white/10 flex items-center justify-center hover:bg-white/5 transition-colors">
                    <span class="text-sm">üíé</span>
                </button>
                <button class="w-8 h-8 rounded-full bg-card-dark border border-white/10 flex items-center justify-center hover:bg-white/5 transition-colors">
                    <span class="text-sm">üõ∏</span>
                </button>
                <button onclick="location.reload()" class="w-8 h-8 rounded-full bg-card-dark border border-white/10 flex items-center justify-center hover:bg-white/5 transition-colors">
                    <span class="material-symbols-outlined text-slate-400 text-sm">refresh</span>
                </button>
            </div>
        </div>

        <!-- Members Grid (Scrollable) -->
        <div class="flex-1 overflow-y-auto no-scrollbar bg-background-dark px-4 pb-32">
            <div id="members-grid" class="grid grid-cols-4 gap-y-8 gap-x-2 pt-4">
                <!-- Skeleton Loading State -->
                <div class="col-span-4 text-center py-10 text-slate-500 text-sm animate-pulse">
                    Connecting to live frequency...
                </div>
            </div>
        </div>

        <!-- Bottom Action Bar -->
        <!-- Hidden by default, shown if user is NOT a member -->
        <div id="join-bar" class="fixed bottom-0 left-0 right-0 p-6 bg-background-dark/95 backdrop-blur-sm border-t border-white/5 z-30 max-w-md mx-auto hidden pb-safe-bottom">
            <button id="join-btn" class="w-full py-4 bg-primary text-white rounded-xl text-base font-bold shadow-lg shadow-primary/20 hover:bg-green-600 active:scale-[0.98] transition-all">
                Join Group Request
            </button>
        </div>

        <!-- Self Controls (Shown if user IS a member) -->
        <div id="member-controls" class="fixed bottom-0 left-0 right-0 p-4 bg-background-dark/95 backdrop-blur-sm border-t border-white/5 z-30 max-w-md mx-auto hidden pb-safe-bottom">
            <div class="flex justify-between items-center gap-4">
                <button class="flex-1 py-3 bg-card-dark border border-white/10 text-slate-300 rounded-xl font-medium hover:bg-white/5 flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">coffee</span> Take Break
                </button>
                <button class="flex-1 py-3 bg-accent text-white rounded-xl font-bold shadow-lg shadow-accent/20 hover:bg-orange-600 flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">play_arrow</span> Start
                </button>
            </div>
        </div>

    </div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, arrayUnion, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDofDHfJvIKQmTtlg7x99mBtimuMmUUhBY",
            authDomain: "facebook-379b3.firebaseapp.com",
            projectId: "facebook-379b3",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentGroupId = null;

        // Get Group ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        currentGroupId = urlParams.get('id');

        if (!currentGroupId) {
            alert("No group specified!");
            window.location.href = '../groups/';
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadGroupData();
            } else {
                window.location.href = "../auth/";
            }
        });

        function loadGroupData() {
            const groupRef = doc(db, "groups", currentGroupId);

            // Real-time listener for group data
            onSnapshot(groupRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    renderPage(data);
                } else {
                    document.getElementById('room-title').innerText = "Group not found";
                }
            });
        }

        async function renderPage(groupData) {
            // 1. Update Header
            const icon = groupData.groupIcon ? '' : (groupData.icon || 'üåì'); 
            document.getElementById('room-title').innerHTML = `${icon} ${groupData.name} ‚è∞`;
            
            const members = groupData.members || [];
            document.getElementById('member-count').innerText = `${members.length} members`;

            // 2. Check Membership & Show Bottom Bar
            const isMember = members.includes(currentUser.uid);
            const joinBar = document.getElementById('join-bar');
            const memberControls = document.getElementById('member-controls');
            const joinBtn = document.getElementById('join-btn');

            if (isMember) {
                joinBar.classList.add('hidden');
                memberControls.classList.remove('hidden');
            } else {
                joinBar.classList.remove('hidden');
                memberControls.classList.add('hidden');
                
                joinBtn.onclick = async () => {
                    joinBtn.innerHTML = `<span class="material-symbols-outlined animate-spin">progress_activity</span> Joining...`;
                    try {
                        const groupRef = doc(db, "groups", currentGroupId);
                        await updateDoc(groupRef, {
                            members: arrayUnion(currentUser.uid)
                        });
                        // UI will auto-update via onSnapshot
                    } catch (error) {
                        console.error("Error joining:", error);
                        alert("Failed to join group.");
                        joinBtn.innerText = "Join Group Request";
                    }
                };
            }

            // 3. Render Grid
            // Note: Since we don't have a real "Live Session" backend yet, 
            // we will simulate the UI states based on the member list to match the screenshot.
            const grid = document.getElementById('members-grid');
            grid.innerHTML = '';

            // Add "You" first if member
            if (isMember) {
                grid.innerHTML += getMemberHTML(currentUser.uid, true, 'studying'); 
            }

            // Render other members (Simulated Data for UI Demo)
            // In a real app, you would fetch user profiles here
            let count = 0;
            members.forEach(uid => {
                if (uid === currentUser.uid) return;
                
                // Simulation: Randomly assign states to make it look like the screenshot
                const states = ['studying', 'break', 'offline', 'offline', 'studying'];
                const randomState = states[count % states.length];
                
                grid.innerHTML += getMemberHTML(uid, false, randomState, count);
                count++;
            });
        }

        // Helper to generate the specific card HTML matching the design
        function getMemberHTML(uid, isMe, state, index = 0) {
            // Mock names and times
            const names = ["HoSnA..", "raisa‚ô°", "Minhaj", "TonmoY.", "Ethereal", "Neha üçÅ", "Raik", "NezukoüçÇ"];
            const displayName = isMe ? "You" : (names[index % names.length] || "User");
            
            // Random time generation
            const h = String(Math.floor(Math.random() * 12)).padStart(2, '0');
            const m = String(Math.floor(Math.random() * 60)).padStart(2, '0');
            const s = String(Math.floor(Math.random() * 60)).padStart(2, '0');
            const timeStr = `${h}:${m}:${s}`;

            let contentHTML = '';
            let textColor = '';
            let opacity = '';

            if (state === 'studying') {
                textColor = 'text-accent'; // Orange
                opacity = 'opacity-100';
                // Active Studying Visual (Photo or Icon)
                // Randomly decide between photo style or icon style
                if (index % 2 === 0) {
                    contentHTML = `
                        <div class="relative w-16 h-16 mb-1">
                            <div class="w-full h-full rounded-xl bg-cover bg-center border-2 border-accent overflow-hidden" style="background-image: url('https://api.dicebear.com/9.x/avataaars/svg?seed=${uid}'); background-color: #2a2a2a;"></div>
                            <div class="absolute -top-4 -right-2"><span class="text-xl">ü§Ø</span></div>
                        </div>
                    `;
                } else {
                    contentHTML = `
                         <div class="relative w-16 h-16 mb-1 flex items-center justify-center">
                            <div class="w-8 h-14 bg-black border border-red-500/50 rounded flex flex-col items-center justify-center overflow-hidden">
                                <span class="material-symbols-outlined text-slate-500 text-xs">videocam</span>
                            </div>
                        </div>
                    `;
                }
            } else if (state === 'break') {
                textColor = 'text-accent';
                opacity = 'opacity-100';
                contentHTML = `
                    <div class="relative w-16 h-16 mb-1 flex items-center justify-center">
                        <span class="material-symbols-outlined text-[40px] text-accent">coffee</span>
                    </div>
                `;
                displayName = "Break"; // Often shown as status
            } else {
                // Offline
                textColor = 'text-slate-600';
                opacity = 'opacity-40';
                contentHTML = `
                    <div class="relative w-16 h-16 mb-1 flex items-center justify-center">
                        <span class="material-symbols-outlined text-[40px] text-slate-600 font-thin">desk</span>
                        <div class="absolute bottom-0 right-1">
                            <span class="material-symbols-outlined text-[14px]">schedule</span>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="flex flex-col items-center ${opacity}">
                    ${contentHTML}
                    <span class="text-[10px] font-bold ${textColor} truncate w-full text-center">${displayName}</span>
                    <span class="text-[10px] font-mono ${state === 'offline' ? 'text-slate-700' : 'text-slate-500'}">${state === 'offline' ? '--:--:--' : timeStr}</span>
                </div>
            `;
        }

    </script>
</body>
</html>