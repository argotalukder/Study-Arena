<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>FocusGroup - Groups</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#22C55E",
                        "primary-dark": "#16a34a",
                        "background-dark": "#121212",
                        "surface-light": "#1E1E1E",
                        "card-border": "#2d2d2d",
                        "input-dark": "#2A2A2A",
                    },
                    fontFamily: { "display": ["Lexend", "sans-serif"] }
                }
            }
        }
    </script>
    <style> 
        body { font-family: 'Lexend', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .font-variation-settings-fill { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    </style>
</head>
<body class="bg-black text-white antialiased selection:bg-primary selection:text-white flex justify-center min-h-screen">

    <!-- Mobile App Container -->
    <div class="w-full max-w-md bg-background-dark min-h-[100dvh] flex flex-col relative shadow-2xl overflow-hidden border-x border-card-border/30">
        
        <!-- Header Section -->
        <header class="flex-shrink-0 z-50 bg-background-dark/95 backdrop-blur-md px-5 py-4 flex items-center justify-between">
            <h1 class="text-[22px] font-bold text-white tracking-tight">Study Groups</h1>
            <a href="create-group.html" class="flex items-center justify-center w-10 h-10 rounded-full bg-primary/10 hover:bg-primary/20 text-primary transition-colors active:scale-95">
                <span class="material-symbols-outlined font-semibold text-[22px]">add</span>
            </a>
        </header>

        <!-- Search Bar -->
        <div class="px-5 pb-2 pt-1 sticky top-[72px] z-40 bg-background-dark/95 backdrop-blur-md border-b border-card-border">
            <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none material-symbols-outlined text-gray-400 text-[22px]">search</span>
                <input id="search-input" class="block w-full pl-12 pr-4 py-3 bg-input-dark border border-card-border rounded-2xl text-white placeholder-gray-500 focus:ring-1 focus:ring-primary focus:border-primary transition-all text-sm font-medium" placeholder="Search groups or subjects..." type="text"/>
            </div>
        </div>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto no-scrollbar pb-28 flex flex-col relative">
            
            <!-- Real Dynamic Groups Section -->
            <div class="px-5 pt-5 flex-1 flex flex-col">
                <div class="flex items-center justify-between mb-4 px-1">
                    <h2 class="text-[17px] font-bold text-white tracking-wide">Explore Groups</h2>
                </div>
                
                <!-- Loading Indicator -->
                <div id="loading" class="text-center py-16 text-gray-400 flex flex-col items-center">
                    <div class="w-10 h-10 border-4 border-card-border border-t-primary rounded-full animate-spin mb-4"></div>
                    <span class="text-sm font-medium">Fetching active groups...</span>
                </div>

                <!-- Real Data List -->
                <div id="groups-list" class="flex flex-col gap-3.5 hidden">
                    <!-- Data will be injected here by JavaScript -->
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="absolute bottom-0 left-0 right-0 bg-surface-light border-t border-card-border pb-6 pt-3 px-6 flex justify-between items-end z-50">
            <a class="flex flex-col items-center justify-end gap-1.5 text-gray-400 group hover:text-gray-200 transition-colors" href="dashboard.html">
                <span class="material-symbols-outlined text-[28px]">home</span>
                <p class="text-[10px] font-medium leading-none">Home</p>
            </a>
            <a class="flex flex-col items-center justify-end gap-1.5 text-gray-400 group hover:text-gray-200 transition-colors" href="#">
                <span class="material-symbols-outlined text-[28px]">calendar_month</span>
                <p class="text-[10px] font-medium leading-none">Calendar</p>
            </a>
            <a class="flex flex-col items-center justify-end gap-1.5 text-primary group" href="groups.html">
                <span class="material-symbols-outlined text-[28px] font-variation-settings-fill">groups</span>
                <p class="text-[10px] font-medium leading-none">Groups</p>
            </a>
            <a class="flex flex-col items-center justify-end gap-1.5 text-gray-400 group hover:text-gray-200 transition-colors" href="#">
                <span class="material-symbols-outlined text-[28px]">smart_toy</span>
                <p class="text-[10px] font-medium leading-none">AI</p>
            </a>
            <a class="flex flex-col items-center justify-end gap-1.5 text-gray-400 group hover:text-gray-200 transition-colors" href="profile.html">
                <span class="material-symbols-outlined text-[28px]">person</span>
                <p class="text-[10px] font-medium leading-none">Profile</p>
            </a>
        </nav>
    </div>

    <!-- Firebase Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDofDHfJvIKQmTtlg7x99mBtimuMmUUhBY",
            authDomain: "facebook-379b3.firebaseapp.com",
            projectId: "facebook-379b3",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allGroups =[];
        let currentUserUid = null;

        onAuthStateChanged(auth, (user) => {
            if (user) { 
                currentUserUid = user.uid;
                loadAllGroups(); 
            } else { 
                window.location.href = "index.html"; 
            }
        });

        function loadAllGroups() {
            // FIX: Removed 'where' clause to fetch both Public and Private groups
            const q = query(collection(db, "groups"));
            
            onSnapshot(q, (snapshot) => {
                const loader = document.getElementById('loading');
                const listContainer = document.getElementById('groups-list');
                
                allGroups =[];
                snapshot.forEach((doc) => { allGroups.push({ id: doc.id, ...doc.data() }); });
                
                // Sort: 1. Joined Groups, 2. Newest Groups
                allGroups.sort((a, b) => {
                    const amIMemberA = a.members && a.members.includes(currentUserUid);
                    const amIMemberB = b.members && b.members.includes(currentUserUid);
                    if (amIMemberA && !amIMemberB) return -1;
                    if (!amIMemberA && amIMemberB) return 1;
                    return (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0);
                });

                renderGroups(allGroups);
                loader.classList.add('hidden');
                listContainer.classList.remove('hidden');
            });
        }

        function renderGroups(groupsToRender) {
            const listContainer = document.getElementById('groups-list');
            listContainer.innerHTML = '';
            
            if(groupsToRender.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-500 mt-10">No groups found.</p>`;
                return;
            }

            groupsToRender.forEach((group) => {
                const avatarHTML = group.groupIcon 
                    ? `<div class="w-16 h-16 flex-shrink-0 mr-4 rounded-[1rem] bg-cover bg-center border border-card-border shadow-sm" style="background-image: url('${group.groupIcon}')"></div>`
                    : `<div class="w-16 h-16 flex-shrink-0 mr-4 rounded-[1rem] flex items-center justify-center bg-input-dark border border-card-border text-primary shadow-sm"><span class="material-symbols-outlined text-[28px]">category</span></div>`;

                const isMember = group.members && group.members.includes(currentUserUid);
                // If member, go to Chat. If not, go to Preview (where Private logic is handled).
                const targetPage = isMember ? `group-chat.html?id=${group.id}` : `group-preview.html?id=${group.id}`;
                
                // Badge Logic (Public vs Private vs Joined)
                let badgeHTML = '';
                if (isMember) {
                    badgeHTML = `<span class="text-[10px] text-white font-bold bg-green-600 px-2 py-0.5 rounded-md uppercase tracking-wider flex-shrink-0 flex items-center gap-1"><span class="material-symbols-outlined text-[10px]">check</span> Joined</span>`;
                } else if (group.privacy === 'private') {
                    badgeHTML = `<span class="text-[10px] text-red-400 font-bold bg-red-500/10 border border-red-500/20 px-2 py-0.5 rounded-md uppercase tracking-wider flex-shrink-0 flex items-center gap-1"><span class="material-symbols-outlined text-[10px]">lock</span> Private</span>`;
                } else {
                    badgeHTML = `<span class="text-[10px] text-primary font-bold bg-primary/10 border border-primary/20 px-2 py-0.5 rounded-md uppercase tracking-wider flex-shrink-0">Public</span>`;
                }

                const groupHTML = `
                    <div onclick="window.location.href='${targetPage}'" class="flex items-center p-3 bg-surface-light rounded-[1.25rem] border border-card-border shadow-sm hover:border-gray-600 transition-colors cursor-pointer group active:scale-[0.98]">
                        ${avatarHTML}
                        <div class="flex-1 min-w-0 py-1">
                            <div class="flex justify-between items-start">
                                <h3 class="text-[15px] font-bold text-white truncate pr-2">${group.name}</h3>
                            </div>
                            <p class="text-[12px] text-gray-400 truncate mt-0.5">${group.category} â€¢ ${group.description || "No description"}</p>
                            <div class="flex items-center gap-2 mt-2">
                                ${badgeHTML}
                                <span class="text-[11px] text-gray-500 font-medium flex items-center gap-1">
                                    <span class="material-symbols-outlined text-[13px]">person</span> ${group.memberCount || 1} Member(s)
                                </span>
                            </div>
                        </div>
                        <div class="ml-2 flex-shrink-0 text-gray-500 bg-background-dark p-2 rounded-full border border-card-border group-hover:text-white transition-colors">
                            <span class="material-symbols-outlined text-[20px]">${isMember ? 'chat' : 'chevron_right'}</span>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', groupHTML);
            });
        }

        // Search Filter
        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            const filteredGroups = allGroups.filter(g => 
                (g.name && g.name.toLowerCase().includes(searchTerm)) || 
                (g.category && g.category.toLowerCase().includes(searchTerm))
            );
            renderGroups(filteredGroups);
        });
    </script>
</body>
</html>