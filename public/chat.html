<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Group Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#22C55E",
                        "background-dark": "#121212",
                        "surface-dark": "#1E1E1E",
                        "input-dark": "#2A2A2A",
                    },
                    fontFamily: { "display": ["Lexend", "sans-serif"] }
                },
            },
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-background-dark font-display text-white min-h-screen flex flex-col">

    <!-- Header -->
    <header class="flex items-center justify-between px-4 py-3 bg-surface-dark border-b border-white/5 z-10 sticky top-0">
        <div class="flex items-center gap-3">
            <a href="dashboard.html" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-white/10 transition-colors">
                <span class="material-symbols-outlined">arrow_back</span>
            </a>
            <div>
                <h1 id="group-title" class="text-base font-bold leading-tight">Study Group</h1>
                <p class="text-xs text-green-400 font-medium">Online</p>
            </div>
        </div>
        <a href="video-call.html" class="flex items-center justify-center w-10 h-10 rounded-full bg-primary/10 text-primary hover:bg-primary/20 transition-colors">
            <span class="material-symbols-outlined">videocam</span>
        </a>
    </header>

    <!-- Chat Area -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-24">
        <!-- Messages will load here -->
        <div class="text-center text-gray-500 text-sm mt-10">Start the conversation!</div>
    </main>

    <!-- Input Area -->
    <div class="fixed bottom-0 w-full bg-surface-dark px-4 py-3 border-t border-white/5 flex items-center gap-2 pb-6">
        <button class="text-gray-400 hover:text-primary transition-colors p-2">
            <span class="material-symbols-outlined">add_circle</span>
        </button>
        <form id="message-form" class="flex-1 flex gap-2">
            <input id="msg-input" autocomplete="off" class="flex-1 bg-input-dark rounded-full px-4 py-2.5 text-sm text-white border-none focus:ring-1 focus:ring-primary" placeholder="Type a message..." type="text"/>
            <button type="submit" class="bg-primary text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg active:scale-95">
                <span class="material-symbols-outlined" style="font-size: 20px;">send</span>
            </button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDofDHfJvIKQmTtlg7x99mBtimuMmUUhBY",
            authDomain: "facebook-379b3.firebaseapp.com",
            databaseURL: "https://facebook-379b3-default-rtdb.firebaseio.com",
            projectId: "facebook-379b3",
            storageBucket: "facebook-379b3.firebasestorage.app",
            messagingSenderId: "953265803311",
            appId: "1:953265803311:web:13224cb211b82b1e36f6da"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Get Group ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const groupId = urlParams.get('groupId') || 'global-chat'; 
        const groupName = urlParams.get('name') || 'Global Study Group';
        
        document.getElementById('group-title').innerText = groupName;

        const chatContainer = document.getElementById('chat-container');
        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadMessages();
            } else {
                window.location.href = "index.html";
            }
        });

        // Load Messages Realtime
        function loadMessages() {
            const q = query(collection(db, "chats", groupId, "messages"), orderBy("createdAt", "asc"));
            
            onSnapshot(q, (snapshot) => {
                chatContainer.innerHTML = '';
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    const isMe = msg.uid === currentUser.uid;
                    
                    const div = document.createElement('div');
                    div.className = `flex w-full ${isMe ? 'justify-end' : 'justify-start'}`;
                    
                    div.innerHTML = `
                        <div class="max-w-[75%] px-4 py-2 rounded-2xl text-sm ${isMe ? 'bg-primary text-white rounded-br-none' : 'bg-input-dark text-gray-200 rounded-bl-none'}">
                            <p class="font-bold text-[10px] opacity-70 mb-0.5">${msg.sender}</p>
                            <p>${msg.text}</p>
                        </div>
                    `;
                    chatContainer.appendChild(div);
                });
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }

        // Send Message
        document.getElementById('message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            
            if (text && currentUser) {
                input.value = ''; // Clear input immediately for UX
                await addDoc(collection(db, "chats", groupId, "messages"), {
                    text: text,
                    uid: currentUser.uid,
                    sender: currentUser.email.split('@')[0], // Simple username
                    createdAt: serverTimestamp()
                });
            }
        });
    </script>
</body>
</html>