<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Group Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#22C55E", 
                        "primary-dark": "#16a34a",
                        "background-dark": "#121212",
                        "surface-dark": "#1E1E1E",
                        "input-bar": "#2A2A2A",
                    },
                    fontFamily: { "display": ["Lexend", "sans-serif"] },
                },
            },
        }
    </script>
    <style> 
        body { font-family: 'Lexend', sans-serif; -webkit-tap-highlight-color: transparent; } 
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .font-variation-settings-fill { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    </style>
</head>
<body class="bg-black text-white flex justify-center min-h-screen">
    <div class="w-full max-w-md bg-background-dark min-h-[100dvh] flex flex-col relative shadow-2xl border-x border-input-bar/30 overflow-hidden">
        
        <!-- Header -->
        <header class="flex items-center justify-between px-4 py-3 bg-surface-dark border-b border-input-bar z-20 sticky top-0">
            <div class="flex items-center gap-3">
                <button onclick="window.location.href='groups.html'" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-input-bar transition-colors text-gray-300">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <div class="flex flex-col justify-center cursor-pointer" onclick="goToGroupInfo()">
                    <h1 id="chat-title" class="text-[16px] font-bold text-white leading-tight truncate max-w-[180px]">Loading...</h1>
                    <p id="chat-subtitle" class="text-[11px] text-gray-400 font-medium">Connecting...</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button class="flex items-center justify-center w-10 h-10 rounded-full bg-input-bar hover:bg-[#333] transition-colors text-primary">
                    <span class="material-symbols-outlined text-[20px]">call</span>
                </button>
                <button class="flex items-center justify-center w-10 h-10 rounded-full bg-input-bar hover:bg-[#333] transition-colors text-primary">
                    <span class="material-symbols-outlined text-[20px]">videocam</span>
                </button>
            </div>
        </header>

        <!-- Focus Room Banner -->
        <div class="bg-green-900/20 w-full px-4 py-1.5 flex items-center justify-center gap-2 border-b border-green-900/30">
            <span class="relative flex h-2 w-2">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
            </span>
            <span class="text-[10px] font-bold text-green-400 uppercase tracking-wider">Focus Room 1 - Active Session</span>
        </div>

        <!-- Messages Area -->
        <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-5 bg-background-dark no-scrollbar pb-40">
            <!-- Messages will load here -->
            <div class="flex justify-center mt-4"><div class="w-6 h-6 border-2 border-primary border-t-transparent rounded-full animate-spin"></div></div>
        </main>

        <!-- Bottom Section (Input + Nav) -->
        <div class="absolute bottom-0 left-0 w-full bg-background-dark z-30">
            
            <!-- Input Area -->
            <div class="px-3 pb-3 pt-2">
                <!-- Image Preview (Hidden by default) -->
                <div id="image-preview-area" class="hidden px-2 pb-2">
                    <div class="relative inline-block">
                        <img id="image-preview" src="" class="h-16 w-16 rounded-lg object-cover border border-gray-600">
                        <button id="remove-image" class="absolute -top-1 -right-1 bg-red-500 rounded-full p-0.5 text-white"><span class="material-symbols-outlined text-[14px]">close</span></button>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <!-- Plus Icon -->
                    <button class="text-gray-400 hover:text-white transition-colors">
                        <span class="material-symbols-outlined text-[26px]">add_circle</span>
                    </button>
                    
                    <!-- Camera Icon (Triggers Upload) -->
                    <input type="file" id="image-input" class="hidden" accept="image/*">
                    <button id="image-btn" class="text-gray-400 hover:text-white transition-colors">
                        <span class="material-symbols-outlined text-[26px]">photo_camera</span>
                    </button>
                    
                    <!-- Text Input Field -->
                    <div class="flex-1 bg-input-bar rounded-full px-4 py-3 flex items-center justify-between transition-all focus-within:ring-1 focus-within:ring-gray-600">
                        <input id="message-input" type="text" class="bg-transparent border-none focus:ring-0 text-sm text-white w-full placeholder-gray-500 p-0 font-medium" placeholder="Type a message...">
                        <button class="text-gray-400 hover:text-white ml-2">
                            <span class="material-symbols-outlined text-[22px]">sentiment_satisfied</span>
                        </button>
                    </div>
                    
                    <!-- Send Button -->
                    <button id="send-btn" class="bg-primary hover:bg-primary-dark text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg shadow-primary/20 transition-all active:scale-90 flex-shrink-0">
                        <span class="material-symbols-outlined text-[22px] ml-1">send</span>
                    </button>
                </div>
            </div>

            <!-- Bottom Navigation -->
            <nav class="bg-surface-dark border-t border-input-bar pb-6 pt-2 px-6 flex justify-between items-end">
                <a class="flex flex-col items-center justify-end gap-1 text-gray-400 group hover:text-white transition-colors" href="dashboard.html">
                    <span class="material-symbols-outlined text-[24px] group-active:scale-90 transition-transform">home</span>
                    <p class="text-[10px] font-medium leading-none">Home</p>
                </a>
                <a class="flex flex-col items-center justify-end gap-1 text-gray-400 group hover:text-white transition-colors" href="#">
                    <span class="material-symbols-outlined text-[24px] group-active:scale-90 transition-transform">calendar_month</span>
                    <p class="text-[10px] font-medium leading-none">Calendar</p>
                </a>
                <a class="flex flex-col items-center justify-end gap-1 text-primary group relative" href="groups.html">
                    <div class="absolute top-0 right-3 w-2 h-2 bg-red-500 rounded-full border-2 border-surface-dark"></div>
                    <span class="material-symbols-outlined text-[24px] font-variation-settings-fill group-active:scale-90 transition-transform">groups</span>
                    <p class="text-[10px] font-medium leading-none">Groups</p>
                </a>
                <a class="flex flex-col items-center justify-end gap-1 text-gray-400 group hover:text-white transition-colors" href="#">
                    <span class="material-symbols-outlined text-[24px] group-active:scale-90 transition-transform">smart_toy</span>
                    <p class="text-[10px] font-medium leading-none">AI</p>
                </a>
                <a class="flex flex-col items-center justify-end gap-1 text-gray-400 group hover:text-white transition-colors" href="profile.html">
                    <span class="material-symbols-outlined text-[24px] group-active:scale-90 transition-transform">person</span>
                    <p class="text-[10px] font-medium leading-none">Profile</p>
                </a>
            </nav>
        </div>
    </div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDofDHfJvIKQmTtlg7x99mBtimuMmUUhBY",
            authDomain: "facebook-379b3.firebaseapp.com",
            projectId: "facebook-379b3",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const imgbbApiKey = "957a2f2e8fc22269da1f2045b3f25eab";

        const urlParams = new URLSearchParams(window.location.search);
        const groupId = urlParams.get('id');

        let currentUser = null;
        let currentUserData = {};

        // UI Refs
        const chatContainer = document.getElementById("chat-container");
        const msgInput = document.getElementById("message-input");
        const sendBtn = document.getElementById("send-btn");
        const imgInput = document.getElementById("image-input");
        const imgBtn = document.getElementById("image-btn");
        const imgPreviewArea = document.getElementById("image-preview-area");
        const imgPreview = document.getElementById("image-preview");
        const removeImg = document.getElementById("remove-image");

        let selectedImage = null;

        window.goToGroupInfo = () => window.location.href = `group-info.html?id=${groupId}`;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await getDoc(doc(db, "users", user.uid));
                currentUserData = userDoc.exists() ? userDoc.data() : { fullName: "User", photoURL: "" };
                loadGroupInfo();
                loadMessages();
            } else {
                window.location.href = "index.html";
            }
        });

        async function loadGroupInfo() {
            if(!groupId) return;
            const groupDoc = await getDoc(doc(db, "groups", groupId));
            if(groupDoc.exists()){
                const data = groupDoc.data();
                document.getElementById("chat-title").innerText = data.name;
                document.getElementById("chat-subtitle").innerText = `${data.memberCount || 1} Members â€¢ 5 Online`;
            }
        }

        function loadMessages() {
            if(!groupId) return;
            const q = query(collection(db, "groups", groupId, "messages"), orderBy("createdAt", "asc"));
            
            onSnapshot(q, (snapshot) => {
                chatContainer.innerHTML = "";
                let lastDate = null;

                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    const isOwn = msg.senderId === currentUser.uid;
                    
                    // Date Divider
                    const msgDate = msg.createdAt ? new Date(msg.createdAt.toMillis()).toDateString() : "Today";
                    if(msgDate !== lastDate) {
                        chatContainer.insertAdjacentHTML('beforeend', `
                            <div class="flex justify-center mb-6">
                                <span class="text-[10px] font-medium text-gray-500 bg-surface-dark px-3 py-1 rounded-full border border-input-bar shadow-sm">
                                    ${msgDate === new Date().toDateString() ? 'Today' : msgDate}
                                </span>
                            </div>
                        `);
                        lastDate = msgDate;
                    }

                    const time = msg.createdAt ? new Date(msg.createdAt.toMillis()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "";

                    // Image Content
                    let contentHtml = "";
                    if(msg.image) {
                        contentHtml += `<div class="mb-2 rounded-xl overflow-hidden"><img src="${msg.image}" class="w-full object-cover max-h-60 min-w-[150px]"></div>`;
                    }
                    if(msg.text) {
                        contentHtml += `<p>${msg.text}</p>`;
                    }

                    const msgHTML = `
                    <div class="flex items-end gap-3 group ${isOwn ? 'justify-end' : ''}">
                        ${!isOwn ? `<div class="w-8 h-8 rounded-full bg-cover bg-center border border-gray-700 flex-shrink-0" style="background-image: url('${msg.senderPhoto}')"></div>` : ''}
                        
                        <div class="flex flex-col gap-1 max-w-[75%] ${isOwn ? 'items-end' : 'items-start'}">
                            ${!isOwn ? `<span class="text-[11px] text-gray-400 ml-1 font-medium">${msg.senderName.split(' ')[0]}</span>` : ''}
                            
                            <div class="px-4 py-3 ${isOwn ? 'bg-primary text-white rounded-[1.2rem] rounded-br-none' : 'bg-input-bar text-gray-200 rounded-[1.2rem] rounded-bl-none'} shadow-sm text-[14px] leading-relaxed break-words border border-transparent ${!isOwn ? 'border-gray-800' : ''}">
                                ${contentHtml}
                            </div>
                            
                            ${isOwn 
                                ? `<span class="text-[10px] text-gray-500 mr-1 flex items-center gap-1 font-medium">${time} <span class="material-symbols-outlined text-[14px] text-primary">done_all</span></span>` 
                                : ''}
                        </div>
                    </div>`;
                    
                    chatContainer.insertAdjacentHTML('beforeend', msgHTML);
                });
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }

        // Image Selection Logic
        imgBtn.onclick = () => imgInput.click();
        imgInput.onchange = (e) => {
            const file = e.target.files[0];
            if(file) {
                selectedImage = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    imgPreview.src = e.target.result;
                    imgPreviewArea.classList.remove("hidden");
                }
                reader.readAsDataURL(file);
            }
        };
        removeImg.onclick = () => {
            selectedImage = null;
            imgInput.value = "";
            imgPreviewArea.classList.add("hidden");
        };

        // Send Message
        sendBtn.addEventListener("click", async () => {
            const text = msgInput.value.trim();
            if(!text && !selectedImage) return;

            msgInput.value = "";
            imgPreviewArea.classList.add("hidden");
            const tempImg = selectedImage;
            selectedImage = null;

            let imageUrl = null;

            if(tempImg) {
                const formData = new FormData();
                formData.append('image', tempImg);
                try {
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, { method: 'POST', body: formData });
                    const data = await res.json();
                    if(data.success) imageUrl = data.data.url;
                } catch(e) { console.error("Image Upload Failed", e); }
            }

            try {
                await addDoc(collection(db, "groups", groupId, "messages"), {
                    text: text,
                    image: imageUrl,
                    senderId: currentUser.uid,
                    senderName: currentUserData.fullName,
                    senderPhoto: currentUserData.photoURL || `https://ui-avatars.com/api/?name=${currentUserData.fullName}&background=random`,
                    createdAt: serverTimestamp()
                });
            } catch(e) { console.error("Send Failed", e); }
        });
        
        // Enter key to send
        msgInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                sendBtn.click();
            }
        });
    </script>
</body>
</html>