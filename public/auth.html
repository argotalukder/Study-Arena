<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>FocusGroup - Auth & Onboarding</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#22C55E",
                        "background-dark": "#121212",
                        "input-dark": "#1E1E1E",
                        "surface-dark": "#1E1E1E"
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    }
                },
            },
        }
    </script>
    <style>
        body { min-height: max(884px, 100dvh); }
        .hidden-section { display: none !important; }
        /* Loader Spinner */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #22C55E; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-background-dark font-display text-white antialiased">

    <!-- Global Full Screen Loader -->
    <div id="global-loader" class="fixed inset-0 z-50 bg-background-dark flex flex-col items-center justify-center">
        <div class="loader mb-4" style="width: 40px; height: 40px;"></div>
        <p class="text-gray-400">Loading FocusGroup...</p>
    </div>

    <!-- ================= AUTH SECTION (LOGIN / SIGNUP) ================= -->
    <section id="auth-section" class="hidden-section relative flex h-full min-h-screen w-full max-w-md mx-auto flex-col overflow-x-hidden bg-background-dark">
        <div class="flex items-center p-4 pb-2 justify-center sticky top-0 z-10">
            <h2 class="text-white text-xl font-bold leading-tight tracking-tight">FocusGroup</h2>
        </div>
        <div class="flex flex-col items-center justify-center px-6 py-6 w-full flex-grow">
            <div class="mb-8 flex justify-center">
                <div class="flex items-center justify-center size-20 rounded-2xl bg-primary/20 text-primary">
                    <span class="material-symbols-outlined text-4xl">school</span>
                </div>
            </div>
            <h2 id="auth-title" class="text-white tracking-tight text-[28px] font-bold text-center pb-2">Join Today</h2>
            <p id="auth-subtitle" class="text-gray-400 text-base text-center pb-8">Start your study journey with us</p>
            
            <form id="auth-form" class="flex w-full flex-col gap-4">
                <label class="flex flex-col w-full">
                    <p class="text-white text-sm font-medium pb-2">Email</p>
                    <div class="relative">
                        <input id="auth-email" required class="w-full rounded-xl border border-gray-600 bg-input-dark focus:border-primary focus:ring-1 focus:ring-primary h-12 p-4 text-white placeholder:text-gray-500" placeholder="student@example.com" type="email"/>
                        <span class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-gray-500">mail</span>
                    </div>
                </label>
                <label class="flex flex-col w-full">
                    <p class="text-white text-sm font-medium pb-2">Password</p>
                    <div class="relative">
                        <input id="auth-password" required minlength="6" class="w-full rounded-xl border border-gray-600 bg-input-dark focus:border-primary focus:ring-1 focus:ring-primary h-12 p-4 text-white placeholder:text-gray-500" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" type="password"/>
                        <span class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 cursor-pointer" onclick="togglePassword('auth-password')">visibility_off</span>
                    </div>
                </label>
                <label id="confirm-password-container" class="flex flex-col w-full">
                    <p class="text-white text-sm font-medium pb-2">Confirm Password</p>
                    <div class="relative">
                        <input id="auth-confirm-password" class="w-full rounded-xl border border-gray-600 bg-input-dark focus:border-primary focus:ring-1 focus:ring-primary h-12 p-4 text-white placeholder:text-gray-500" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" type="password"/>
                    </div>
                </label>

                <p id="auth-error" class="text-red-500 text-sm hidden"></p>

                <div id="terms-container" class="flex flex-col gap-3 w-full py-4">
                    <div class="flex items-start gap-3 w-full">
                        <input id="terms" required type="checkbox" class="h-5 w-5 rounded border-gray-600 text-primary focus:ring-primary bg-input-dark"/>
                        <label for="terms" class="text-sm text-gray-400">I agree to the <a class="text-primary hover:underline" href="#">Terms and Privacy Policy</a></label>
                    </div>
                </div>

                <button type="submit" id="auth-submit-btn" class="w-full rounded-xl bg-primary px-4 py-3.5 text-white font-bold text-base shadow-sm hover:bg-green-600 transition-colors flex justify-center items-center gap-2">
                    <span>Sign Up</span>
                </button>
            </form>
            <div class="pt-6 pb-4 text-center">
                <p id="auth-toggle-text" class="text-gray-400 text-sm">
                    Already have an account? 
                    <button onclick="toggleAuthMode()" class="text-primary font-bold hover:underline ml-1">Login</button>
                </p>
            </div>
        </div>
    </section>

    <!-- ================= ONBOARDING STEP 1 (PROFILE) ================= -->
    <section id="onboarding-1" class="hidden-section relative flex h-full min-h-screen w-full max-w-md mx-auto flex-col overflow-hidden bg-background-dark shadow-xl">
        <div class="flex flex-col gap-3 px-6 pt-8 pb-4">
            <div class="flex gap-6 justify-between items-center">
                <button onclick="signOutUser()" class="text-white hover:bg-white/10 rounded-full p-2 -ml-2 transition-colors">
                    <span class="material-symbols-outlined text-2xl">logout</span>
                </button>
                <p class="text-gray-400 text-sm font-medium">Step 1 of 2</p>
            </div>
            <div class="rounded-full bg-surface-dark h-1.5 w-full mt-2">
                <div class="h-1.5 rounded-full bg-primary transition-all duration-500 ease-out" style="width: 50%;"></div>
            </div>
        </div>
        <div class="flex-1 flex flex-col px-6 pb-6">
            <h1 class="text-white tracking-tight text-[22px] font-bold text-center pt-4 pb-8">Tell us about yourself</h1>
            
            <form id="step1-form" class="flex flex-col flex-1">
                <div class="flex flex-col items-center justify-center mb-8">
                    <label for="profile-upload" class="relative group cursor-pointer">
                        <div id="profile-preview-container" class="w-[100px] h-[100px] rounded-full border-2 border-dashed border-gray-300 bg-surface-dark flex items-center justify-center overflow-hidden hover:border-primary transition-colors bg-cover bg-center">
                            <span id="profile-icon" class="material-symbols-outlined text-white/50 text-4xl group-hover:scale-110 transition-transform">add_a_photo</span>
                        </div>
                        <div class="absolute bottom-0 right-0 bg-primary text-white rounded-full p-1.5 border-2 border-[#121212] flex items-center justify-center shadow-sm">
                            <span class="material-symbols-outlined text-sm font-bold">edit</span>
                        </div>
                        <input type="file" id="profile-upload" accept="image/*" class="hidden" onchange="previewImage(event)"/>
                    </label>
                    <p class="text-gray-400 text-sm mt-3 text-center">Upload Profile Picture</p>
                </div>
                
                <div class="flex flex-col gap-5 w-full">
                    <label class="flex flex-col gap-1.5 w-full">
                        <span class="text-gray-200 text-sm font-medium ml-1">Full Name</span>
                        <div class="relative flex items-center">
                            <span class="absolute left-4 material-symbols-outlined text-gray-400">person</span>
                            <input id="ob-fullname" required class="flex w-full rounded-xl text-white border border-gray-600 bg-surface-dark focus:border-primary h-14 pl-12 pr-4 text-base" placeholder="Enter your full name" type="text"/>
                        </div>
                    </label>
                    <label class="flex flex-col gap-1.5 w-full">
                        <span class="text-gray-200 text-sm font-medium ml-1">Username</span>
                        <div class="relative flex items-center">
                            <span class="absolute left-4 material-symbols-outlined text-gray-400">alternate_email</span>
                            <input id="ob-username" required class="flex w-full rounded-xl text-white border border-gray-600 bg-surface-dark focus:border-primary h-14 pl-12 pr-4 text-base" placeholder="Enter a username" type="text"/>
                        </div>
                    </label>
                </div>
                
                <p id="step1-error" class="text-red-500 text-sm hidden mt-4"></p>
                <div class="flex-1 min-h-[40px]"></div>
                
                <button type="submit" id="step1-btn" class="w-full bg-primary hover:bg-primary/90 text-white font-semibold h-14 rounded-xl flex items-center justify-center gap-2 transition-all mt-auto">
                    <span class="text-lg">Next</span>
                    <span class="material-symbols-outlined text-xl">arrow_forward</span>
                </button>
            </form>
        </div>
    </section>

    <!-- ================= ONBOARDING STEP 2 (STUDIES) ================= -->
    <section id="onboarding-2" class="hidden-section relative flex h-full min-h-screen w-full max-w-md mx-auto flex-col overflow-hidden bg-background-dark shadow-xl">
        <div class="flex flex-col gap-2 px-6 pt-8 pb-6">
            <div class="flex justify-between items-end">
                <p class="text-sm font-medium text-gray-400">Step 2 of 2</p>
                <span class="text-xs font-bold text-primary">100%</span>
            </div>
            <div class="h-2 w-full overflow-hidden rounded-full bg-surface-dark">
                <div class="h-full rounded-full bg-primary transition-all duration-500" style="width: 100%"></div>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto px-6 pb-28 no-scrollbar">
            <h1 class="text-3xl font-bold text-white mb-2">Your Studies</h1>
            <p class="text-gray-400 mb-8 text-sm">Tell us about your current academic status.</p>
            
            <form id="step2-form" class="flex flex-col gap-6">
                <div class="flex flex-col gap-2">
                    <label class="text-sm font-semibold text-gray-300">Education Level</label>
                    <select id="ob-level" required class="w-full rounded-xl border border-gray-600 bg-surface-dark py-3.5 px-4 text-white focus:border-primary outline-none">
                        <option value="" disabled selected>Select level</option>
                        <option value="HSC">Higher Secondary (HSC)</option>
                        <option value="SSC">Secondary (SSC)</option>
                        <option value="A-Levels">A-Levels</option>
                        <option value="O-Levels">O-Levels</option>
                        <option value="University">University</option>
                    </select>
                </div>
                
                <div class="flex flex-col gap-2">
                    <label class="text-sm font-semibold text-gray-300">Class / Year</label>
                    <select id="ob-year" required class="w-full rounded-xl border border-gray-600 bg-surface-dark py-3.5 px-4 text-white focus:border-primary outline-none">
                        <option value="" disabled selected>Select your year</option>
                        <option value="11">1st Year (XI)</option>
                        <option value="12">2nd Year (XII)</option>
                        <option value="Admission">Admission Candidate</option>
                        <option value="9">Class 9</option>
                        <option value="10">Class 10</option>
                    </select>
                </div>
                
                <div class="flex flex-col gap-2">
                    <label class="text-sm font-semibold text-gray-300">Institution Name</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 material-symbols-outlined text-gray-400">school</span>
                        <input id="ob-institution" required class="w-full rounded-xl border border-gray-600 bg-surface-dark py-3.5 pl-11 pr-4 text-white placeholder-gray-500 focus:border-primary outline-none" placeholder="e.g. Notre Dame College" type="text"/>
                    </div>
                </div>
                
                <div class="flex flex-col gap-3 pt-2">
                    <label class="text-sm font-semibold text-gray-300">Select Focus Subjects</label>
                    <div id="subject-container" class="flex flex-wrap gap-2">
                        <!-- Subjects will be handled by JS -->
                    </div>
                </div>

                <div class="flex flex-col gap-3 pt-2">
                    <label class="text-sm font-semibold text-gray-300">Primary Goal</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div onclick="selectGoal('University')" id="goal-uni" class="goal-card cursor-pointer relative flex flex-col items-start gap-2 rounded-xl border-2 border-transparent bg-surface-dark p-4 transition-all">
                            <div class="check-icon absolute right-3 top-3 hidden size-5 items-center justify-center rounded-full bg-primary text-white">
                                <span class="material-symbols-outlined text-sm font-bold">check</span>
                            </div>
                            <div class="rounded-lg bg-background-dark p-2 text-gray-300 icon-bg">
                                <span class="material-symbols-outlined">school</span>
                            </div>
                            <div>
                                <h4 class="font-bold text-white">University</h4>
                                <p class="text-xs text-gray-400">Admission Prep</p>
                            </div>
                        </div>
                        <div onclick="selectGoal('Exam Score')" id="goal-exam" class="goal-card cursor-pointer relative flex flex-col items-start gap-2 rounded-xl border-2 border-transparent bg-surface-dark p-4 transition-all">
                            <div class="check-icon absolute right-3 top-3 hidden size-5 items-center justify-center rounded-full bg-primary text-white">
                                <span class="material-symbols-outlined text-sm font-bold">check</span>
                            </div>
                            <div class="rounded-lg bg-background-dark p-2 text-gray-300 icon-bg">
                                <span class="material-symbols-outlined">monitoring</span>
                            </div>
                            <div>
                                <h4 class="font-bold text-white">Exam Score</h4>
                                <p class="text-xs text-gray-500">Board Results</p>
                            </div>
                        </div>
                    </div>
                </div>
                <p id="step2-error" class="text-red-500 text-sm hidden"></p>
            </form>
        </div>
        <div class="absolute bottom-0 w-full bg-background-dark border-t border-surface-dark p-4 pb-8 max-w-md mx-auto">
            <button onclick="document.getElementById('step2-form').dispatchEvent(new Event('submit'))" id="step2-btn" class="flex w-full items-center justify-center gap-2 rounded-xl bg-primary px-6 py-4 text-base font-bold text-white shadow-lg hover:bg-primary/90 transition-all">
                Get Started ðŸš€
            </button>
        </div>
    </section>

    <!-- ================= DASHBOARD (SUCCESS PLACEHOLDER) ================= -->
    <section id="dashboard-section" class="hidden-section flex h-screen w-full flex-col items-center justify-center bg-background-dark text-white">
        <span class="material-symbols-outlined text-6xl text-primary mb-4">check_circle</span>
        <h1 class="text-2xl font-bold mb-2">Welcome to FocusGroup!</h1>
        <p class="text-gray-400 mb-6">Your profile has been set up successfully.</p>
        <button onclick="signOutUser()" class="px-6 py-2 bg-surface-dark rounded-xl border border-gray-600 hover:bg-gray-800">Log out</button>
    </section>

    <!-- ================= FIREBASE & LOGIC ================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
        
        // Your Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDofDHfJvIKQmTtlg7x99mBtimuMmUUhBY",
            authDomain: "facebook-379b3.firebaseapp.com",
            databaseURL: "https://facebook-379b3-default-rtdb.firebaseio.com",
            projectId: "facebook-379b3",
            storageBucket: "facebook-379b3.firebasestorage.app",
            messagingSenderId: "953265803311",
            appId: "1:953265803311:web:13224cb211b82b1e36f6da"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // ImgBB API KEY
        const IMGBB_API_KEY = "957a2f2e8fc22269da1f2045b3f25eab";

        // State Variables
        let isLoginMode = false;
        let currentUser = null;
        let profileFile = null;
        let selectedSubjects =[];
        let selectedGoal = null;

        const subjectsList =["Physics", "Higher Math", "Chemistry", "Biology", "ICT", "English", "Accounting", "Finance"];

        // DOM Elements
        const globalLoader = document.getElementById('global-loader');
        const sections = {
            auth: document.getElementById('auth-section'),
            step1: document.getElementById('onboarding-1'),
            step2: document.getElementById('onboarding-2'),
            dashboard: document.getElementById('dashboard-section')
        };

        // Initialize UI
        function showSection(sectionId) {
            Object.values(sections).forEach(sec => sec.classList.add('hidden-section'));
            sections[sectionId].classList.remove('hidden-section');
        }

        // Subject Rendering
        function renderSubjects() {
            const container = document.getElementById('subject-container');
            container.innerHTML = '';
            subjectsList.forEach(sub => {
                const isSelected = selectedSubjects.includes(sub);
                const btn = document.createElement('button');
                btn.type = "button";
                btn.className = isSelected 
                    ? "group flex items-center gap-1.5 rounded-full border border-primary bg-primary/10 px-4 py-2 text-sm font-medium text-primary transition-colors"
                    : "group flex items-center gap-1.5 rounded-full border border-transparent bg-surface-dark px-4 py-2 text-sm font-medium text-gray-300 hover:bg-[#2A2A2A] transition-colors";
                btn.innerHTML = isSelected ? `<span class="material-symbols-outlined text-lg">check</span>${sub}` : sub;
                btn.onclick = () => {
                    if(isSelected) selectedSubjects = selectedSubjects.filter(s => s !== sub);
                    else selectedSubjects.push(sub);
                    renderSubjects();
                };
                container.appendChild(btn);
            });
        }
        renderSubjects();

        // Goal Selection Logic (Exposed to window for inline onclick)
        window.selectGoal = (goal) => {
            selectedGoal = goal;
            document.querySelectorAll('.goal-card').forEach(card => {
                card.classList.remove('border-primary', 'bg-primary/10');
                card.classList.add('border-transparent');
                card.querySelector('.check-icon').classList.add('hidden');
                card.querySelector('.icon-bg').classList.replace('text-primary', 'text-gray-300');
            });
            const activeCard = goal === 'University' ? document.getElementById('goal-uni') : document.getElementById('goal-exam');
            activeCard.classList.remove('border-transparent');
            activeCard.classList.add('border-primary', 'bg-primary/10');
            activeCard.querySelector('.check-icon').classList.remove('hidden');
            activeCard.querySelector('.icon-bg').classList.replace('text-gray-300', 'text-primary');
        };

        // Auth Mode Toggle (Exposed to window)
        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-title').innerText = isLoginMode ? "Welcome Back" : "Join Today";
            document.getElementById('auth-subtitle').innerText = isLoginMode ? "Log in to continue studying" : "Start your study journey with us";
            document.getElementById('auth-submit-btn').innerHTML = `<span>${isLoginMode ? "Log In" : "Sign Up"}</span>`;
            document.getElementById('auth-toggle-text').innerHTML = isLoginMode 
                ? `Don't have an account? <button onclick="toggleAuthMode()" class="text-primary font-bold hover:underline ml-1">Sign up</button>`
                : `Already have an account? <button onclick="toggleAuthMode()" class="text-primary font-bold hover:underline ml-1">Login</button>`;
            
            document.getElementById('confirm-password-container').classList.toggle('hidden', isLoginMode);
            document.getElementById('terms-container').classList.toggle('hidden', isLoginMode);
            document.getElementById('auth-confirm-password').required = !isLoginMode;
            document.getElementById('terms').required = !isLoginMode;
            document.getElementById('auth-error').classList.add('hidden');
        };

        // Toggle Password visibility
        window.togglePassword = (id) => {
            const input = document.getElementById(id);
            if (input.type === "password") {
                input.type = "text";
                event.target.innerText = "visibility";
            } else {
                input.type = "password";
                event.target.innerText = "visibility_off";
            }
        };

        // Image Preview Local
        window.previewImage = (e) => {
            const file = e.target.files[0];
            if (file) {
                profileFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const container = document.getElementById('profile-preview-container');
                    container.style.backgroundImage = `url('${e.target.result}')`;
                    document.getElementById('profile-icon').classList.add('hidden');
                }
                reader.readAsDataURL(file);
            }
        };

        // Sign Out (Exposed to window)
        window.signOutUser = () => {
            signOut(auth);
        };

        // Check user state and route
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        if (data.onboardingStep === 'completed') {
                            window.location.href = "dashboard.html"; // Redirect to dashboard
                        } else if (data.onboardingStep === 'step1_done') {
                            showSection('step2');
                        } else {
                            showSection('step1');
                        }
                    } else {
                        // Document doesn't exist yet, start onboarding
                        showSection('step1');
                    }
                } catch (error) {
                    console.error("Error fetching user data:", error);
                    showSection('step1'); // Fallback to step 1
                }
            } else {
                currentUser = null;
                showSection('auth');
            }
            globalLoader.classList.add('hidden');
        });

        // Setup setLoading helper
        function setLoading(btnId, isLoading, originalText) {
            const btn = document.getElementById(btnId);
            if(isLoading){
                btn.disabled = true;
                btn.innerHTML = `<div class="loader" style="width:20px;height:20px;border-top-color:white;"></div>`;
            } else {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Handle Auth Submit
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const confirm = document.getElementById('auth-confirm-password').value;
            const errorEl = document.getElementById('auth-error');
            
            errorEl.classList.add('hidden');

            if (!isLoginMode && password !== confirm) {
                errorEl.innerText = "Passwords do not match!";
                errorEl.classList.remove('hidden');
                return;
            }

            setLoading('auth-submit-btn', true, '');
            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                    // OnAuthStateChanged will handle routing
                }
            } catch (error) {
                errorEl.innerText = error.message.replace('Firebase: ', '');
                errorEl.classList.remove('hidden');
                setLoading('auth-submit-btn', false, `<span>${isLoginMode ? "Log In" : "Sign Up"}</span>`);
            }
        });

        // Handle Step 1 Submit (Upload to ImgBB)
        document.getElementById('step1-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fullName = document.getElementById('ob-fullname').value;
            const username = document.getElementById('ob-username').value;
            const errorEl = document.getElementById('step1-error');
            errorEl.classList.add('hidden');

            setLoading('step1-btn', true, '');
            try {
                let photoURL = "";
                
                // Upload Image to ImgBB API
                if (profileFile) {
                    const formData = new FormData();
                    formData.append('image', profileFile);

                    const imgbbResponse = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const imgbbData = await imgbbResponse.json();
                    
                    if (imgbbData.success) {
                        photoURL = imgbbData.data.url; // Get direct image URL from ImgBB
                    } else {
                        throw new Error("Failed to upload image to ImgBB.");
                    }
                }

                // Save data to Firestore Database
                await setDoc(doc(db, "users", currentUser.uid), {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    fullName,
                    username,
                    photoURL, // ImgBB URL
                    onboardingStep: 'step1_done'
                }, { merge: true });

                showSection('step2');
            } catch (error) {
                console.error(error);
                errorEl.innerText = error.message || "Error saving profile.";
                errorEl.classList.remove('hidden');
            } finally {
                setLoading('step1-btn', false, `<span class="text-lg">Next</span><span class="material-symbols-outlined text-xl">arrow_forward</span>`);
            }
        });

        // Handle Step 2 Submit (With Redirect)
        document.getElementById('step2-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const level = document.getElementById('ob-level').value;
            const year = document.getElementById('ob-year').value;
            const institution = document.getElementById('ob-institution').value;
            const errorEl = document.getElementById('step2-error');
            errorEl.classList.add('hidden');

            if (selectedSubjects.length === 0 || !selectedGoal) {
                errorEl.innerText = "Please select at least one subject and a primary goal.";
                errorEl.classList.remove('hidden');
                return;
            }

            setLoading('step2-btn', true, '');
            try {
                await setDoc(doc(db, "users", currentUser.uid), {
                    educationLevel: level,
                    classYear: year,
                    institution,
                    focusSubjects: selectedSubjects,
                    primaryGoal: selectedGoal,
                    onboardingStep: 'completed',
                    createdAt: new Date().toISOString()
                }, { merge: true });

                // Redirect to Dashboard
                window.location.href = "dashboard.html";
            } catch (error) {
                console.error(error);
                errorEl.innerText = "Error saving study details.";
                errorEl.classList.remove('hidden');
            } finally {
                setLoading('step2-btn', false, `Get Started ðŸš€`);
            }
        });

    </script>
</body>
</html>